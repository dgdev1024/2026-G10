#!/bin/bash
set -euo pipefail

# Pre-commit hook: format staged C/C++ files using clang-format
# It will modify files in-place and add them to the commit if needed.

FILES=$(git diff --cached --name-only --diff-filter=ACM | \
    grep -E '\.(c|cpp|cc|h|hpp|hh)$' || true)

if [ -z "${FILES}" ]; then
    # Nothing to do
    exit 0
fi

command -v clang-format >/dev/null 2>&1 || {
    echo "clang-format not found in PATH; skipping format"
    exit 0
}

echo "Formatting staged files:"
echo "${FILES}"

for f in ${FILES}; do
    clang-format -style=file -i "${f}" || true
    git add "${f}"
done

exit 0
