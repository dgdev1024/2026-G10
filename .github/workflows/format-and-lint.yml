name: Format & Lint

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  format-check:
    name: Check clang-format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang-format

      - name: Run clang-format (dry-run)
        run: |
          set -euo pipefail
          FILES=$(git ls-files '\*.cpp' '\*.cc' '\*.c' '\*.hpp' '\*.hh' '\*.h' || true)
          if [ -z "${FILES}" ]; then
            echo "No C/C++ source files found; skipping format check."
            exit 0
          fi
          echo "Checking formatting for the following files:"
          echo "${FILES}"
          # Use style from repo `.clang-format`.
          clang-format -style=file --dry-run --Werror ${FILES}

  clang-tidy:
    name: Optional: Run clang-tidy
    runs-on: ubuntu-latest
    needs: [format-check, generate-compile-commands]
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang-tidy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang-tidy

      - name: Run clang-tidy (if compile_commands.json is present)
        run: |
          set -euo pipefail
          echo "Found compile_commands.json; running clang-tidy."
          # Basic invocation - users can customize checks as needed.
          clang-tidy -p . -quiet $(git ls-files '\*.cpp' '\*.cc' || true) || true

  generate-compile-commands:
    name: Generate compile_commands.json
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install bear & build dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y bear build-essential premake5

      - name: Generate compile_commands.json via `bear`
        run: |
          set -euo pipefail
          chmod +x scripts/build.sh
          # Run build under bear to capture compile commands
          bear -- scripts/build.sh || true
          if [ -f compile_commands.json ]; then
            echo "compile_commands.json generated"
          else
            echo "Failed to generate compile_commands.json"
            exit 0
          fi

  auto-fix-format:
    name: Auto-format and open PR
    runs-on: ubuntu-latest
    needs: format-check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang-format

      - name: Apply clang-format
        run: |
          set -euo pipefail
          FILES=$(git ls-files '\*.cpp' '\*.cc' '\*.c' '\*.hpp' '\*.hh' '\*.h' || true)
          if [ -z "${FILES}" ]; then
            echo "No C/C++ source files found; skipping."; exit 0
          fi
          clang-format -style=file -i ${FILES}
          git status --porcelain

      - name: Commit formatting changes
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "style: apply clang-format" || echo "No changes to commit"
          else
            echo "No formatting changes"
          fi

      - name: Create Pull Request with formatting fixes
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "style: apply clang-format"
          branch: "clang-format-fixes"
          title: "style: apply clang-format"
          body: "This PR applies automatic clang-format changes."
          base: ${{ github.event.pull_request.head.ref || github.ref_name }}
